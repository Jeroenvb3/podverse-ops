# BASE CONFIG

indexer {
    mem_limit = 2G
}

source base {
    type = pgsql
    sql_host = podverse_db
    sql_user = postgres
    sql_pass = mysecretpw
    sql_db = postgres
}

# AUTHOR NAME SEARCH

source author_base: base {
    sql_field_string = name
    sql_attr_string = podverse_id
}

source author: author_base {
    sql_query = \
        SELECT \
            int_id, \
            id AS podverse_id, \
            name \
        FROM authors
}

index idx_author {
    source = author
    path = author_name
    dict = keywords
    index_exact_words = 1
    expand_keywords = 1
    min_infix_len = 3
    charset_table = non_cjk, cjk
    rt_mem_limit = 4G
}

# EPISODE TITLE SEARCH
# NOTE: the episode_export_with_serial_column.csv file must exist (at least an empty placeholder)
# when docker-compose up is run for podverse_manticore, otherwise directories
# will be created in the container instead of the actual files.

source episode_csv {
    type = csvpipe
    csvpipe_command = cat /etc/manticoresearch/episode_export_with_serial_column.csv
    csvpipe_attr_string = podverse_id
    csvpipe_field = title
    csvpipe_attr_uint = pastHourTotalUniquePageviews
    csvpipe_attr_uint = pastDayTotalUniquePageviews
    csvpipe_attr_uint = pastWeekTotalUniquePageviews
    csvpipe_attr_uint = pastMonthTotalUniquePageviews
    csvpipe_attr_uint = pastYearTotalUniquePageviews
    csvpipe_attr_uint = pastAllTimeTotalUniquePageviews
    csvpipe_attr_timestamp = created_date
}

index idx_episode {
    path = episode_title
    source = episode_csv
    dict = keywords
    index_exact_words = 1
    expand_keywords = 1
    min_infix_len = 3
    charset_table = non_cjk
    rt_mem_limit = 8G
}

# MEDIA_REF TITLE SEARCH

source media_ref_base: base {
    sql_field_string = title
    sql_attr_string = podverse_id
    sql_attr_uint = pastHourTotalUniquePageviews
    sql_attr_uint = pastDayTotalUniquePageviews
    sql_attr_uint = pastWeekTotalUniquePageviews
    sql_attr_uint = pastMonthTotalUniquePageviews
    sql_attr_uint = pastYearTotalUniquePageviews
    sql_attr_uint = pastAllTimeTotalUniquePageviews
    sql_attr_timestamp = created_date
}

source media_ref: media_ref_base {
    sql_query = \
        SELECT \
            int_id, \
            id AS podverse_id, \
            title, \
            "pastHourTotalUniquePageviews", \
            "pastDayTotalUniquePageviews", \
            "pastWeekTotalUniquePageviews", \
            "pastMonthTotalUniquePageviews", \
            "pastYearTotalUniquePageviews", \
            "pastAllTimeTotalUniquePageviews", \
            extract(epoch from "createdAt") AS created_date \
        FROM "mediaRefs"
}

index idx_media_ref {
    source = media_ref
    path = media_ref_title
    dict = keywords
    index_exact_words = 1
    expand_keywords = 1
    min_infix_len = 3
    charset_table = non_cjk, cjk
    rt_mem_limit = 4G
}

# PLAYLIST TITLE SEARCH

source playlist_base: base {
    sql_field_string = title
    sql_attr_string = podverse_id
}

source playlist: playlist_base {
    sql_query = \
        SELECT \
            int_id, \
            id AS podverse_id, \
            title \
        FROM playlists
}

index idx_playlist {
    source = playlist
    path = playlist_title
    dict = keywords
    index_exact_words = 1
    expand_keywords = 1
    min_infix_len = 3
    charset_table = non_cjk, cjk
    rt_mem_limit = 4G
}

# PODCAST TITLE SEARCH

source podcast_base: base {
    sql_field_string = title
    sql_attr_string = podverse_id
    sql_attr_uint = pastHourTotalUniquePageviews
    sql_attr_uint = pastDayTotalUniquePageviews
    sql_attr_uint = pastWeekTotalUniquePageviews
    sql_attr_uint = pastMonthTotalUniquePageviews
    sql_attr_uint = pastYearTotalUniquePageviews
    sql_attr_uint = pastAllTimeTotalUniquePageviews
    sql_attr_timestamp = created_date
}

source podcast: podcast_base {
    sql_query = \
        SELECT \
            int_id, \
            id AS podverse_id, \
            title, \
            "pastHourTotalUniquePageviews", \
            "pastDayTotalUniquePageviews", \
            "pastWeekTotalUniquePageviews", \
            "pastMonthTotalUniquePageviews", \
            "pastYearTotalUniquePageviews", \
            "pastAllTimeTotalUniquePageviews", \
            extract(epoch from "lastEpisodePubDate") AS created_date \
        FROM podcasts
}

index idx_podcast {
    source = podcast
    path = podcasts_title
    dict = keywords
    index_exact_words = 1
    expand_keywords = 1
    min_infix_len = 2
    charset_table = non_cjk, cjk
    rt_mem_limit = 4G
}

# SEARCHD CONFIG

searchd {
    listen = 9306:mysql41
    listen = 9308:http
    log = searchd.log
    pid_file = manticoresearch.pid
    binlog_path =
    collation_server = utf8_ci
}
