# BASE CONFIG

indexer {
    mem_limit = 2G
}

source base {
    type = pgsql
    sql_host = podverse_db
    sql_user = postgres
    sql_pass = mysecretpw
    sql_db = postgres
}

# AUTHOR NAME SEARCH

source author_base: base {
    sql_field_string = name
    sql_attr_string = podverse_id
}

source author: author_base {
    sql_query = \
        SELECT \
            int_id, \
            id AS podverse_id, \
            name \
        FROM authors
}

index idx_author {
    source = author
    path = author_name
    min_prefix_len = 2
    min_infix_len = 2
    charset_table = non_cjk, cjk
}

# EPISODE TITLE SEARCH
# NOTE: I'm splitting the csv into chunks then merging them because the indexer operation
# kept failing when trying to run it on the full 80+ million row csv file.
# NOTE: the episode_export_##.csv files must exist when docker-compose up is run
# for podverse_manticore, otherwise directories will be created in the container
# instead of the actual files.

source episode_csv_base {
    type = csvpipe
    csvpipe_field_string = podverseId
    csvpipe_field_string = title
    csvpipe_attr_uint = pastHourTotalUniquePageviews
    csvpipe_attr_uint = pastDayTotalUniquePageviews
    csvpipe_attr_uint = pastWeekTotalUniquePageviews
    csvpipe_attr_uint = pastMonthTotalUniquePageviews
    csvpipe_attr_uint = pastYearTotalUniquePageviews
    csvpipe_attr_uint = pastAllTimeTotalUniquePageviews
}

source episode_csv_00: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_00.csv
}

source episode_csv_01: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_01.csv
}

source episode_csv_02: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_02.csv
}

source episode_csv_03: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_03.csv
}

source episode_csv_04: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_04.csv
}

source episode_csv_05: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_05.csv
}

source episode_csv_06: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_06.csv
}

source episode_csv_07: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_07.csv
}

source episode_csv_08: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_08.csv
}

source episode_csv_09: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_09.csv
}

source episode_csv_10: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_10.csv
}

source episode_csv_11: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_11.csv
}

source episode_csv_12: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_12.csv
}

source episode_csv_13: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_13.csv
}

source episode_csv_14: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_14.csv
}

source episode_csv_15: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_15.csv
}

source episode_csv_16: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_16.csv
}

source episode_csv_17: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_17.csv
}

source episode_csv_18: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_18.csv
}

source episode_csv_19: episode_csv_base {
    csvpipe_command = cat /etc/manticoresearch/episode_export_19.csv
}

index idx_episode {
    path = episode_title_00
    source = episode_csv_00
    min_prefix_len = 3
    min_infix_len = 3
    charset_table = non_cjk, cjk
}

index idx_episode_01: idx_episode {
    path = episode_title_01
    source = episode_csv_01
}

index idx_episode_02: idx_episode {
    path = episode_title_02
    source = episode_csv_02
}

index idx_episode_03: idx_episode {
    path = episode_title_03
    source = episode_csv_03
}

index idx_episode_04: idx_episode {
    path = episode_title_04
    source = episode_csv_04
}

index idx_episode_05: idx_episode {
    path = episode_title_05
    source = episode_csv_05
}

index idx_episode_06: idx_episode {
    path = episode_title_06
    source = episode_csv_06
}

index idx_episode_07: idx_episode {
    path = episode_title_07
    source = episode_csv_07
}

index idx_episode_08: idx_episode {
    path = episode_title_08
    source = episode_csv_08
}

index idx_episode_09: idx_episode {
    path = episode_title_09
    source = episode_csv_09
}

index idx_episode_10: idx_episode {
    path = episode_title_10
    source = episode_csv_10
}

index idx_episode_11: idx_episode {
    path = episode_title_11
    source = episode_csv_11
}

index idx_episode_12: idx_episode {
    path = episode_title_12
    source = episode_csv_12
}

index idx_episode_13: idx_episode {
    path = episode_title_13
    source = episode_csv_13
}

index idx_episode_14: idx_episode {
    path = episode_title_14
    source = episode_csv_14
}

index idx_episode_15: idx_episode {
    path = episode_title_15
    source = episode_csv_15
}

index idx_episode_16: idx_episode {
    path = episode_title_16
    source = episode_csv_16
}

index idx_episode_17: idx_episode {
    path = episode_title_17
    source = episode_csv_17
}

index idx_episode_18: idx_episode {
    path = episode_title_18
    source = episode_csv_18
}

index idx_episode_19: idx_episode {
    path = episode_title_19
    source = episode_csv_19
}

# MEDIA_REF TITLE SEARCH

source media_ref_base: base {
    sql_field_string = title
    sql_attr_string = podverse_id
    sql_attr_string = pastHourTotalUniquePageviews
    sql_attr_string = pastDayTotalUniquePageviews
    sql_attr_string = pastWeekTotalUniquePageviews
    sql_attr_string = pastMonthTotalUniquePageviews
    sql_attr_string = pastYearTotalUniquePageviews
    sql_attr_string = pastAllTimeTotalUniquePageviews
}

source media_ref: media_ref_base {
    sql_query = \
        SELECT \
            int_id, \
            id AS podverse_id, \
            title, \
            "pastHourTotalUniquePageviews", \
            "pastDayTotalUniquePageviews", \
            "pastWeekTotalUniquePageviews", \
            "pastMonthTotalUniquePageviews", \
            "pastYearTotalUniquePageviews", \
            "pastAllTimeTotalUniquePageviews" \
        FROM "mediaRefs"
}

index idx_media_ref {
    source = media_ref
    path = media_ref_title
    min_prefix_len = 2
    min_infix_len = 2
    charset_table = non_cjk, cjk
}

# PLAYLIST TITLE SEARCH

source playlist_base: base {
    sql_field_string = title
    sql_attr_string = podverse_id
}

source playlist: playlist_base {
    sql_query = \
        SELECT \
            int_id, \
            id AS podverse_id, \
            title \
        FROM playlists
}

index idx_playlist {
    source = playlist
    path = playlist_title
    min_prefix_len = 2
    min_infix_len = 2
    charset_table = non_cjk, cjk
}

# PODCAST TITLE SEARCH

source podcast_base: base {
    sql_field_string = title
    sql_attr_string = podverse_id
    sql_attr_string = pastHourTotalUniquePageviews
    sql_attr_string = pastDayTotalUniquePageviews
    sql_attr_string = pastWeekTotalUniquePageviews
    sql_attr_string = pastMonthTotalUniquePageviews
    sql_attr_string = pastYearTotalUniquePageviews
    sql_attr_string = pastAllTimeTotalUniquePageviews
}

source podcast: podcast_base {
    sql_query = \
        SELECT \
            int_id, \
            id AS podverse_id, \
            title, \
            "pastHourTotalUniquePageviews", \
            "pastDayTotalUniquePageviews", \
            "pastWeekTotalUniquePageviews", \
            "pastMonthTotalUniquePageviews", \
            "pastYearTotalUniquePageviews", \
            "pastAllTimeTotalUniquePageviews" \
        FROM podcasts
}

index idx_podcast {
    source = podcast
    path = podcasts_title
    min_prefix_len = 2
    min_infix_len = 2
    charset_table = non_cjk, cjk
}

# SEARCHD CONFIG

searchd {
    listen = 9306:mysql41
    listen = 9308:http
    log = searchd.log
    pid_file = manticoresearch.pid
    binlog_path =
    collation_server = utf8_ci
}
